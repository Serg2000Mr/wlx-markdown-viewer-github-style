# Проект: Markdown Lister для Total Commander (AOT версия)

Этот проект представляет собой высокопроизводительный плагин (.wlx) для просмотра файлов в формате Markdown (.md, .mdc) для Total Commander, оптимизированный для работы без внешних зависимостей.

## Архитектура

1.  **Движок рендеринга (C# Native AOT)**:
    -   Расположение: `MarkdigNative/`
    -   Библиотека: [Markdig](https://github.com/xoofx/markdig)
    -   Технология: .NET 8 Native AOT (Ahead-of-Time компиляция).
    -   Результат: `MarkdigNative-x64.dll` (автономная нативная DLL, не требующая установленного .NET Runtime).
    -   Экспортируемые функции: `ConvertMarkdownToHtml`, `FreeHtmlBuffer`.

2.  **Связующий слой (Pure C++)**:
    -   Расположение: `Markdown/`
    -   Роль: Служит посредником между плагином Lister и движком AOT.
    -   Загрузка: Использует динамическую загрузку (`LoadLibraryW`) для поиска DLL движка AOT относительно собственного пути.
    -   Совместимость: Заменяет старую реализацию C++/CLI для удаления зависимостей от управляемого кода (managed code).

3.  **Плагин Lister (C++)**:
    -   Расположение: `MarkdownView/`
    -   Роль: Реализует API плагинов Lister для Total Commander.
    -   Интерфейс: Использует **WebView2 (Edge/Chromium)** для отображения HTML (основной вариант). При ошибке инициализации WebView2 возможен fallback на legacy IE WebBrowser.
    -   Результат: `MarkdownView.wlx64`.

## Система сборки

-   **Скрипт**: `BuildAll.bat`
-   **Требования**: 
-    -   Visual Studio 2022+ с рабочей нагрузкой C++ (Desktop development with C++).
    -   .NET 8.0 SDK (для AOT компиляции).
-   **Платформа**: В настоящее время оптимизировано для **x64**. (Примечание: .NET 8 Native AOT не поддерживает x86).

Примечание: проекты C++ используют Platform Toolset `v145`. Если у вас установлен другой toolset, откройте `MarkdownView.sln` и выполните Retarget Projects.

## Ключевые компоненты

-   `MarkdigNative/Lib.cs`: Содержит функции C# с атрибутом `[UnmanagedCallersOnly]`, экспортируемые в C++.
-   `Markdown/markdown.cpp`: Обрабатывает динамическую загрузку движка и кодировки символов (UTF-8/UTF-16).
-   `Build/css/github.css`: Современный стиль в духе GitHub, оптимизированный для движка IE.
-   `Build/MarkdownView.ini`: Конфигурация расширений файлов и опций Markdig.
-   `MarkdownView/main.cpp`: Логика UI плагина, тулбар и опциональная инъекция Google Translate.

## Важно для AI-агентов

-   **Управление памятью**: Строки, возвращаемые из C# AOT, должны освобождаться с помощью экспортируемой функции `FreeHtmlBuffer` во избежание утечек.
-   **Разрешение путей**: Связующая DLL (`Markdown-x64.dll`) ищет `MarkdigNative-x64.dll` в той же директории.
-   **Эмодзи `:shortcode:`**: GitHub-стиль `:shortcode:` внутри ссылок (например, `[:arrow_up:Оглавление](#...)`) обрабатывается предобработкой в `MarkdigNative/Lib.cs`, т.к. парсер эмодзи Markdig требует пробел перед `:shortcode:`.
-   **Производительность**: Не добавлять глобальный перехват ресурсов WebView2 (например, `WebResourceRequested` для `*`) без необходимости — это даёт заметную задержку при открытии маленьких Markdown.
-   **Перевод**: При включении плагин инъектирует Google Translate виджет в отрендеренный HTML. Настройки в секции `[Translate]` (`Enabled`, `Auto`, `Target=auto|en|...`) в `Build/MarkdownView.ini`.
-   **Зависимости перевода**: Перевод требует сетевого доступа к `translate.google.com`. Если доступ заблокирован, перевод не будет работать. Реализация может ставить/чистить cookie `googtrans` для принудительной установки целевого языка.
-   **Никакого CLR**: В проектах C++ (`Markdown` и `MarkdownView`) НЕ ДОЛЖЕН быть включен параметр `/clr`. Это чистый нативный код.
