# Проект: Markdown Lister для Total Commander (AOT версия)

Этот проект представляет собой высокопроизводительный плагин для просмотра Markdown (.wlx) для Total Commander, оптимизированный для работы без внешних зависимостей.

## Архитектура

1.  **Движок рендеринга (C# Native AOT)**:
    -   Расположение: `MarkdigNative/`
    -   Библиотека: [Markdig](https://github.com/xoofx/markdig)
    -   Технология: .NET 8 Native AOT (Ahead-of-Time компиляция).
    -   Результат: `MarkdigNative-x64.dll` (автономная нативная DLL, не требующая установленного .NET Runtime).
    -   Экспортируемые функции: `ConvertMarkdownToHtml`, `FreeHtmlBuffer`.

2.  **Связующий слой (Pure C++)**:
    -   Расположение: `Markdown/`
    -   Роль: Служит посредником между плагином Lister и движком AOT.
    -   Загрузка: Использует динамическую загрузку (`LoadLibraryW`) для поиска DLL движка AOT относительно собственного пути.
    -   Совместимость: Заменяет старую реализацию C++/CLI для удаления зависимостей от управляемого кода (managed code).

3.  **Плагин Lister (C++)**:
    -   Расположение: `MarkdownView/`
    -   Роль: Реализует API плагинов Lister для Total Commander.
    -   Интерфейс: Использует движок Internet Explorer 11 (через контрол `WebBrowser`) для отображения HTML.
    -   Результат: `MarkdownView.wlx64`.

## Система сборки

-   **Скрипт**: `BuildAll.bat`
-   **Требования**: 
    -   Visual Studio 2026 (набор инструментов v145).
    -   .NET 8.0 SDK (для AOT компиляции).
-   **Платформа**: В настоящее время оптимизировано для **x64**. (Примечание: .NET 8 Native AOT не поддерживает x86).

## Ключевые компоненты

-   `MarkdigNative/Lib.cs`: Содержит функции C# с атрибутом `[UnmanagedCallersOnly]`, экспортируемые в C++.
-   `Markdown/markdown.cpp`: Обрабатывает динамическую загрузку движка и кодировки символов (UTF-8/UTF-16).
-   `Build/css/github.css`: Современный стиль в духе GitHub, оптимизированный для движка IE.
-   `Build/MarkdownView.ini`: Конфигурация расширений файлов и опций Markdig.

## Важно для AI-агентов

-   **Управление памятью**: Строки, возвращаемые из C# AOT, должны освобождаться с помощью экспортируемой функции `FreeHtmlBuffer` во избежание утечек.
-   **Разрешение путей**: Связующая DLL (`Markdown-x64.dll`) ищет `MarkdigNative-x64.dll` в той же директории.
-   **Совместимость с IE**: Генерируемый HTML включает `<meta http-equiv="X-UA-Compatible" content="IE=edge">` для принудительного использования современного рендеринга.
-   **Никакого CLR**: В проектах C++ (`Markdown` и `MarkdownView`) НЕ ДОЛЖЕН быть включен параметр `/clr`. Это чистый нативный код.
