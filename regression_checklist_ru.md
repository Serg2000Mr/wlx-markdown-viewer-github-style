**Функциональность (что “обязано работать”)**

- **Интеграция с Total Commander Lister**
  - Экспорты `ListLoad / ListLoadNext / ListSendCommand / ListCloseWindow / ListSearchText / ListSearchTextW` (htmlview.def, listerplugin.h, реализация в main.cpp)
  - Поддержка “следующего файла” через `ListLoadNext` и хранение параметров для Refresh
  - Перехват горячих клавиш через `WH_KEYBOARD` hook, прокидывание в окно просмотра

- **Определение типа файла**
  - Markdown по расширениям из ini: `MarkdownExtensions`
  - HTML и сигнатуры (fallback по сигнатуре) через `CSmallStringList`

- **Рендер Markdown → HTML**
  - Архитектура 3 слоёв: AOT C# (`MarkdigNative`), C++ bridge (`Markdown`), UI-плагин (`MarkdownView`)
  - Расширения Markdig из ini `[Renderer] Extensions=...`

- **Отображение через WebView2 + навигация**
  - Создание WebView2, события `NavigationStarting/Completed`, `WebMessageReceived`
  - Обработка кликов по внешним ссылкам: отмена и открытие в браузере по `ShellExecute` только для пользовательской навигации
  - Fallback на `file://` если нет нужного интерфейса WebView2 или mapping не включился

- **Ресурсы и относительные пути (картинки, css, etc.)**
  - Вставка `<base href='...'>` в `<head>` без зависимости от регистра тега
  - Два режима base href:
    - `https://markdown.internal/...` когда включён VirtualHostNameToFolderMapping
    - `file:///...` иначе
  - Важный инвариант: mapping должен указывать на папку исходного `.md`, а не на temp-папку (иначе `img/...` ломается)

- **Временный HTML и кэш**
  - Запись `_markdown_preview_temp.html` в `LocalAppData\\TotalCommanderMarkdownViewPlugin\\l\\`
  - Кэш HTML по ключу (файл + css + extensions + lastWrite + size) и асинхронный рендер в потоке

- **Поиск по странице**
  - `ListSearchText/ListSearchTextW` → `FindText`, опции matchcase/wholewords/backwards

- **Масштаб**
  - Горячие клавиши `Ctrl+Wheel`, `Ctrl+0`, `Ctrl++`, `Ctrl+-` (настраивается в ini)

- **Скрытие/показ изображений**
  - Команды `RemoveImages / HideShowImages` на горячих клавишах F2/Shift+F2

- **Сохранение/восстановление позиции прокрутки**
  - `SavePosition/LoadPosition` (если `UseSavePosition=1`)

- **Фикс якорей внутри страницы**
  - Инъекция обработчика клика по `#anchor` и корректный scrollIntoView

- **Google Translate (опционально)**
  - Инъекция виджета и обмен состоянием с C++ через `postMessage({type:'gt_state'})`
  - Настройки `[Translate] Enabled/Auto/Target`

- **Безопасность/совместимость через ini**
  - `AllowScripting` (нужно для Mermaid), `AllowInternetImages`, `ForceOffline`, `AllowActiveX` и т.п.


**Почему “ломается то, что работало” (корневая причина по проекту)**

- В проекте много “скрытых контрактов” между частями:
  - Откуда именно открывается HTML (temp file vs mapped host) и как это влияет на относительные пути.
  - Порядок вызовов mapping/навигации (один лишний `UpdateFolderMapping` — и всё начинает резолвиться из другой папки).
  - Инъекции в HTML (`<base>`, anchor-fix, translate) завязаны на HTML-структуру и регистр тегов.
  - Асинхронный рендер + кэш легко ломается, если меняется ключ кэша или жизненный цикл окна.


**Регрессионный чеклист (минимальный набор “проверить перед каждым релизом/после фичи”)**

- **Базовые сценарии файлов**
  - Открыть простой `.md` и убедиться, что есть форматирование и CSS применён.
  - Открыть `.md` с локальной картинкой `img/Test2.png` рядом с файлом.
  - Открыть `.md` с якорями/оглавлением (`[#...]`) и пройти по 2–3 ссылкам.
  - Открыть большой `.md` (проверить, что UI не “подвисает”, рендер не ломает прокрутку).

- **Навигация и команды**
  - Назад/вперёд (если применимо), refresh.
  - Поиск `F3`/`Shift+F3` (или через `ListSearchText`), matchcase/wholewords.
  - Zoom: `Ctrl+Wheel`, `Ctrl+0`.
  - Hide/show images: F2/Shift+F2 (если включено в ini).

- **Опции**
  - `AllowScripting=1`: проверить Mermaid/диаграммы (если используются).
  - `ForceOffline=0/1` и `AllowInternetImages=0/1`: не должны ломать локальные картинки.

- **Перевод (если включён)**
  - Нажать кнопку/тулбар переводчика, дождаться “busy → done”, затем вернуть “original”.


**Инструкция “как не сломать при дальнейших изменениях” (правила разработки)**

- **1) Перед правкой формулируй контракт**
  - Пример контракта для ресурсов: “Локальные `img/...` всегда резолвятся относительно папки исходного markdown, независимо от того, где лежит temp HTML”.
  - Пример для HTML-инъекций: “Вставка `<base>` должна работать при любом регистре `<head>` и при наличии/отсутствии `<base>`”.

- **2) Меняй только одну ось за раз**
  - Если правишь навигацию/URL/mapping — не трогай одновременно translate/toolbar/поиск.
  - Если правишь генерацию HTML — не трогай одновременно `Navigate`/lifecycle WebView2.

- **3) Защищай места “скрытых контрактов”**
  - Любая логика, которая:
    - меняет базовый URL (`<base href>`)
    - меняет mapping `markdown.internal`
    - меняет путь temp-файла
    - решает “NavigateToString vs Navigate(file)”
    должна считаться “опасной зоной” и всегда проходить чеклист выше.

- **4) Всегда делай принудительную пересборку перед проверкой**
  - Иначе легко получить эффект “я поменял код, но бинарь не обновился”.
  - Это учтено в `BuildAll.bat` через `/t:Rebuild`.

- **5) Вводи минимальные автоматические проверки там, где можно**
  - Самые дешёвые для автоматизации — чистые функции преобразования строк:
    - вставка `<base>`
    - поиск `<head>/<body>` без регистра
    - инъекция anchor-fix / translate
  - Даже 5–10 таких проверок резко снижают шанс регрессий (можно оформить отдельной маленькой тестовой сборкой/проектом, не зависящей от TC/WebView2).

- **6) Держи “набор эталонных файлов”**
  - Папка `Примеры` уже используется как ручной регрессионный набор.
  - Правило: если фиксил баг — добавь/оставь пример, который этот баг воспроизводит, и включи его в чеклист.

